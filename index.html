<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barcode Scanner App</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            text-align: center;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            text-align: center;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 40px 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 3em;
            margin-bottom: 15px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .main-content {
            padding: 40px 30px;
            text-align: center;
        }

        .action-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .action-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            cursor: pointer;
        }

        .action-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            border-color: #667eea;
        }

        .action-card .icon {
            font-size: 3em;
            margin-bottom: 20px;
            display: block;
        }

        .action-card h3 {
            font-size: 1.4em;
            margin-bottom: 15px;
            color: #333;
            font-weight: 600;
        }

        .action-card p {
            color: #666;
            line-height: 1.5;
            margin-bottom: 20px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            color: #333;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(252, 182, 159, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
            color: #333;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(132, 250, 176, 0.4);
        }

        .stats-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
        }

        .stat-item {
            text-align: center;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 10px;
        }

        .stat-label {
            color: #666;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.9em;
            letter-spacing: 0.5px;
        }

        .recent-scans {
            margin-top: 30px;
            text-align: center;
        }

        .recent-scans h3 {
            margin-bottom: 20px;
            color: #333;
            font-size: 1.5em;
            text-align: center;
        }

        .scan-item {
            background: white;
            border-radius: 10px;
            padding: 15px 20px;
            margin-bottom: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            text-align: center;
        }

        .scan-info {
            flex: 1;
            text-align: center;
        }

        .scan-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .scan-details {
            font-size: 0.9em;
            color: #666;
        }

        .scan-quantity {
            background: #667eea;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-weight: 600;
            font-size: 0.9em;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }

        .empty-state .icon {
            font-size: 4em;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .scanner-section {
            text-align: center;
        }

        .scanner-container {
            text-align: center;
        }

        #scanner {
            text-align: center;
        }

        .scanner-instructions {
            text-align: center;
        }

        .controls {
            text-align: center;
        }

        #status {
            text-align: center;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Quantity Modal Styles */
        .quantity-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .quantity-modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .quantity-modal h3 {
            margin-bottom: 20px;
            color: #333;
            font-size: 1.5em;
        }

        .product-info {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .product-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .product-brand {
            color: #666;
            font-size: 0.9em;
        }

        .quantity-input-group {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
        }

        .quantity-btn {
            background: #667eea;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.2em;
            transition: all 0.3s ease;
        }

        .quantity-btn:hover {
            background: #5a67d8;
            transform: scale(1.1);
        }

        .quantity-input {
            width: 80px;
            padding: 8px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1.1em;
            text-align: center;
            font-weight: 600;
        }

        .quantity-input:focus {
            border-color: #667eea;
            outline: none;
        }

        .modal-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        /* Items Modal Styles */
        .items-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .items-modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .items-modal h2 {
            margin-bottom: 20px;
            color: #333;
            text-align: center;
        }

        .items-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .item-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr auto;
            gap: 15px;
            padding: 12px;
            border-bottom: 1px solid #e9ecef;
            align-items: center;
        }

        .item-row:hover {
            background-color: #f8f9fa;
        }

        .item-details h4 {
            margin: 0 0 5px 0;
            color: #333;
        }

        .item-details p {
            margin: 0;
            color: #666;
            font-size: 0.9em;
        }

        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 0.8em;
        }

        .delete-btn:hover {
            background: #c82333;
        }

        /* Dataset Modal Styles */
        .dataset-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .dataset-modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 70vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .dataset-modal h2 {
            margin-bottom: 20px;
            color: #333;
            text-align: center;
        }

        .current-dataset {
            background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .dataset-list {
            margin-bottom: 20px;
        }

        .dataset-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .dataset-item.active {
            border-color: #667eea;
            background-color: #f8f9ff;
        }

        .dataset-info h4 {
            margin: 0 0 5px 0;
            color: #333;
        }

        .dataset-info p {
            margin: 0;
            color: #666;
            font-size: 0.9em;
        }

        .dataset-actions {
            display: flex;
            gap: 10px;
        }

        .dataset-actions button {
            padding: 4px 8px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8em;
        }

        .activate-btn {
            background: #28a745;
            color: white;
        }

        .activate-btn:hover {
            background: #218838;
        }

        .new-dataset-form {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .new-dataset-input {
            flex: 1;
            padding: 8px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
        }

        .new-dataset-input:focus {
            border-color: #667eea;
            outline: none;
        }

        .close-modal {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        .close-modal:hover {
            color: #333;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }

            .header {
                padding: 30px 20px;
            }

            .header h1 {
                font-size: 2.5em;
            }

            .main-content {
                padding: 30px 20px;
            }

            .action-grid {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .scan-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .scan-quantity {
                align-self: flex-end;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📱 Barcode Scanner</h1>
            <p>Scan barcodes and lookup product information</p>
        </div>

        <div class="main-content">
            <div class="scanner-section">
                <div class="dataset-info">
                    <h3>📁 Current Dataset: <span id="currentDatasetDisplay">Default Dataset</span></h3>
                    <button class="btn btn-secondary" onclick="openDatasetModal()" style="margin-bottom: 20px;">Switch Dataset</button>
                </div>
                
                <div class="scanner-container">
                    <div id="scanner">
                        <p>Click "Start Scanner" to begin scanning barcodes</p>
                    </div>
                    <div class="scanner-overlay">
                        <div class="scan-area">
                            <div class="scan-corners">
                                <div class="scan-corner top-left"></div>
                                <div class="scan-corner top-right"></div>
                                <div class="scan-corner bottom-left"></div>
                                <div class="scan-corner bottom-right"></div>
                            </div>
                            <div class="scan-line"></div>
                        </div>
                        <div class="scanner-instructions">
                            Place the barcode within the scan area.
                        </div>
                    </div>
                </div>

                <div class="controls">
                    <button id="startBtn" class="btn btn-primary">Start Scanner</button>
                    <button id="stopBtn" class="btn btn-secondary" disabled>Stop Scanner</button>
                </div>

                <div id="status" class="status hidden"></div>
            </div>

            <div class="action-grid">
                <div class="action-card">
                    <div class="icon">📷</div>
                    <h3>Start Scanning</h3>
                    <p>Use your device camera to scan barcodes and automatically lookup product information</p>
                    <button class="btn btn-primary" onclick="scrollToScanner()">Open Scanner</button>
                </div>

                <div class="action-card">
                    <div class="icon">📋</div>
                    <h3>View Scanned Items</h3>
                    <p>Review all your scanned products and manage your inventory</p>
                    <button class="btn btn-secondary" onclick="viewScannedItems()">View Items</button>
                </div>

                <div class="action-card">
                    <div class="icon">📄</div>
                    <h3>Export to PDF</h3>
                    <p>Generate a comprehensive PDF report of all scanned items</p>
                    <div id="loadingPDF" class="loading">
                        <div class="loading-spinner"></div>
                        <p>Generating PDF...</p>
                    </div>
                    <button class="btn btn-success" onclick="exportToPDF()">Export PDF</button>
                </div>

                <div class="action-card">
                    <div class="icon">🗂️</div>
                    <h3>Manage Datasets</h3>
                    <p>Create, switch between, and manage multiple datasets for your scanned items</p>
                    <button class="btn btn-primary" onclick="openDatasetManager()">Manage Datasets</button>
                </div>
            </div>

            <div class="stats-section">
                <h3>📊 Scanning Statistics</h3>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-number" id="totalItems">0</div>
                        <div class="stat-label">Total Items</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="totalQuantity">0</div>
                        <div class="stat-label">Total Quantity</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="foundProducts">0</div>
                        <div class="stat-label">Found Products</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="unknownProducts">0</div>
                        <div class="stat-label">Unknown Products</div>
                    </div>
                </div>
            </div>

            <div class="recent-scans">
                <h3>🕒 Recent Scans</h3>
                <div id="recentScansList"></div>
            </div>
        </div>
    </div>

    <!-- Quantity Modal -->
    <div id="quantityModal" class="quantity-modal">
        <div class="quantity-modal-content">
            <h3>Set Quantity</h3>
            <div class="product-info">
                <div class="product-name" id="modalProductName">Product Name</div>
                <div class="product-brand" id="modalProductBrand">Brand Name</div>
            </div>
            <div class="quantity-input-group">
                <button class="quantity-btn" onclick="adjustQuantity(-1)">-</button>
                <input type="number" id="quantityInput" class="quantity-input" value="1" min="1">
                <button class="quantity-btn" onclick="adjustQuantity(1)">+</button>
            </div>
            <div class="modal-actions">
                <button class="btn btn-primary" onclick="confirmQuantity()">Confirm</button>
                <button class="btn btn-secondary" onclick="cancelQuantity()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Items Modal -->
    <div id="itemsModal" class="items-modal">
        <div class="items-modal-content">
            <h2>Scanned Items - <span id="itemsModalDatasetName">Current Dataset</span></h2>
            <button class="close-modal" onclick="closeItemsModal()">&times;</button>
            <div style="margin-bottom: 20px; text-align: center;">
                <button class="btn btn-danger" onclick="deleteAllItems()">Delete All Items</button>
            </div>
            <div class="items-list" id="itemsList">
                <!-- Items will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Dataset Modal -->
    <div id="datasetModal" class="dataset-modal">
        <div class="dataset-modal-content">
            <h2>Manage Datasets</h2>
            <button class="close-modal" onclick="closeDatasetModal()">&times;</button>
            <div class="current-dataset">
                <h4>Current Dataset:</h4>
                <p id="currentDatasetName">No dataset selected</p>
            </div>
            <div class="dataset-list" id="datasetList">
                <!-- Dataset items will be loaded here -->
            </div>
            <div class="new-dataset-form">
                <input type="text" id="newDatasetName" placeholder="New Dataset Name">
                <button class="btn btn-primary" onclick="createNewDataset()">Create New Dataset</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <script>
        class BarcodeScanner {
            constructor() {
                this.isScanning = false;
                this.scannedCodes = new Set();
                this.currentProductInfo = null;
                this.initializeElements();
                this.bindEvents();
            }

            initializeElements() {
                this.startBtn = document.getElementById('startBtn');
                this.stopBtn = document.getElementById('stopBtn');
                this.scanner = document.getElementById('scanner');
                this.status = document.getElementById('status');
                this.quantityModal = document.getElementById('quantityModal');
                this.quantityInput = document.getElementById('quantityInput');
            }

            bindEvents() {
                this.startBtn.addEventListener('click', () => this.startScanning());
                this.stopBtn.addEventListener('click', () => this.stopScanning());
            }

            async startScanning() {
                try {
                    this.updateStatus('Requesting camera permission...', 'info');
                    
                    // Check if camera is available
                    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                        throw new Error('Camera access is not supported in this browser. Please use a modern browser like Chrome, Firefox, or Safari.');
                    }

                    // First, request camera permission explicitly
                    let stream;
                    try {
                        // Try with back camera first (for mobile)
                        stream = await navigator.mediaDevices.getUserMedia({ 
                            video: { 
                                facingMode: { ideal: "environment" },
                                width: { ideal: 640 },
                                height: { ideal: 480 }
                            } 
                        });
                    } catch (backCameraError) {
                        console.log('Back camera not available, trying front camera:', backCameraError);
                        try {
                            // Fallback to front camera
                            stream = await navigator.mediaDevices.getUserMedia({ 
                                video: { 
                                    facingMode: "user",
                                    width: { ideal: 640 },
                                    height: { ideal: 480 }
                                } 
                            });
                        } catch (frontCameraError) {
                            console.log('Front camera not available, trying any camera:', frontCameraError);
                            // Fallback to any available camera with minimal constraints
                            stream = await navigator.mediaDevices.getUserMedia({ 
                                video: true 
                            });
                        }
                    }

                    // Stop the stream as Quagga will handle it
                    if (stream) {
                        stream.getTracks().forEach(track => track.stop());
                    }

                    this.updateStatus('Initializing scanner...', 'info');
                    this.startBtn.disabled = true;
                    this.stopBtn.disabled = false;
                    this.isScanning = true;

                    // Configure Quagga with more permissive settings
                    const config = {
                        inputStream: {
                            name: "Live",
                            type: "LiveStream",
                            target: this.scanner,
                            constraints: {
                                width: { min: 320, ideal: 640, max: 1920 },
                                height: { min: 240, ideal: 480, max: 1080 },
                                aspectRatio: { min: 1, max: 2 },
                                facingMode: "environment" // Prefer back camera
                            }
                        },
                        locator: {
                            patchSize: "medium",
                            halfSample: true
                        },
                        numOfWorkers: navigator.hardwareConcurrency || 2,
                        decoder: {
                            readers: [
                                "code_128_reader",
                                "ean_reader",
                                "ean_8_reader",
                                "code_39_reader",
                                "upc_reader",
                                "upc_e_reader"
                            ]
                        },
                        locate: true
                    };

                    // Try with environment camera first
                    Quagga.init(config, (err) => {
                        if (err) {
                            console.log('Environment camera failed, trying user camera:', err);
                            
                            // Fallback to front camera
                            config.inputStream.constraints.facingMode = "user";
                            
                            Quagga.init(config, (err2) => {
                                if (err2) {
                                    console.log('User camera failed, trying any camera:', err2);
                                    
                                    // Final fallback - remove facingMode constraint
                                    delete config.inputStream.constraints.facingMode;
                                    
                                    Quagga.init(config, (err3) => {
                                        if (err3) {
                                            console.error('All camera options failed:', err3);
                                            this.updateStatus('Failed to initialize scanner. Please check camera permissions and try again.', 'error');
                                            this.resetButtons();
                                            return;
                                        }
                                        this.startQuagga();
                                    });
                                } else {
                                    this.startQuagga();
                                }
                            });
                        } else {
                            this.startQuagga();
                        }
                    });

                } catch (error) {
                    console.error('Error starting scanner:', error);
                    let errorMessage = 'Error starting scanner: ';
                    
                    if (error.name === 'NotAllowedError') {
                        errorMessage += 'Camera permission denied. Please allow camera access and try again.';
                    } else if (error.name === 'NotFoundError') {
                        errorMessage += 'No camera found on this device.';
                    } else if (error.name === 'NotReadableError') {
                        errorMessage += 'Camera is already in use by another application.';
                    } else if (error.name === 'OverconstrainedError') {
                        errorMessage += 'Camera constraints not supported.';
                    } else {
                        errorMessage += error.message;
                    }
                    
                    this.updateStatus(errorMessage, 'error');
                    this.resetButtons();
                }
            }

            startQuagga() {
                console.log("Quagga initialization finished. Starting scanner...");
                Quagga.start();
                this.updateStatus('Scanner active - Point camera at barcode', 'success');
                
                // Listen for successful scans
                Quagga.onDetected((result) => {
                    const code = result.codeResult.code;
                    
                    // Prevent duplicate scans within a short time
                    if (!this.scannedCodes.has(code)) {
                        this.scannedCodes.add(code);
                        this.handleBarcodeDetected(code);
                        
                        // Remove from set after 1 second to allow rescanning
                        setTimeout(() => {
                            this.scannedCodes.delete(code);
                        }, 1000);
                    }
                });
            }

            stopScanning() {
                if (this.isScanning) {
                    Quagga.stop();
                    this.isScanning = false;
                    this.resetButtons();
                    this.updateStatus('Scanner stopped', 'info');
                    this.scanner.innerHTML = '<p>Click "Start Scanner" to begin scanning barcodes</p>';
                }
            }

            resetButtons() {
                this.startBtn.disabled = false;
                this.stopBtn.disabled = true;
            }

            updateStatus(message, type = 'info') {
                this.status.className = `status ${type}`;
                this.status.textContent = message;
                this.status.style.display = 'block';
                
                // Auto-hide status after 5 seconds for success messages
                if (type === 'success') {
                    setTimeout(() => {
                        this.status.style.display = 'none';
                    }, 5000);
                }
            }

            async handleBarcodeDetected(code) {
                console.log('Barcode detected:', code);
                this.updateStatus(`Barcode detected: ${code}`, 'success');
                
                // Play a beep sound (if supported)
                this.playBeep();
                
                // Look up product information
                await this.lookupProduct(code);
            }

            playBeep() {
                try {
                    // Create a simple beep sound
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.value = 800;
                    oscillator.type = 'sine';
                    
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
                    
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.1);
                } catch (error) {
                    console.log('Could not play beep sound:', error);
                }
            }

            async lookupProduct(barcode) {
                try {
                    this.updateStatus('Looking up product information...', 'info');
                    
                    let productInfo = {
                        code: barcode,
                        timestamp: new Date().toISOString(),
                        found: false,
                        quantity: 1
                    };
                    
                    // Try multiple databases for product information
                    let productFound = false;
                    
                    // Try Open Food Facts API first
                    try {
                        const offResponse = await fetch(`https://world.openfoodfacts.org/api/v0/product/${barcode}.json`);
                        const offData = await offResponse.json();
                        
                        if (offData.status === 1 && offData.product) {
                            const product = offData.product;
                            productInfo = {
                                ...productInfo,
                                found: true,
                                productName: product.product_name || 'Unknown Product',
                                productBrand: product.brands || 'Unknown Brand',
                                productCategory: product.categories_tags ? product.categories_tags[0] : 'Unknown Category',
                                productSize: product.quantity || product.serving_size || product.net_weight || 'Unknown Size',
                                productImage: product.image_url || null
                            };
                            productFound = true;
                            this.updateStatus(`Found: ${productInfo.productName}`, 'success');
                        }
                    } catch (offError) {
                        console.log('Open Food Facts lookup failed:', offError);
                    }
                    
                    // If not found in Open Food Facts, try UPCitemdb
                    if (!productFound) {
                        try {
                            const upcResponse = await fetch(`https://api.upcitemdb.com/prod/trial/lookup?upc=${barcode}`);
                            const upcData = await upcResponse.json();
                            
                            if (upcData.code === "OK" && upcData.items && upcData.items.length > 0) {
                                const item = upcData.items[0];
                                productInfo = {
                                    ...productInfo,
                                    found: true,
                                    productName: item.title || 'Unknown Product',
                                    productBrand: item.brand || 'Unknown Brand',
                                    productCategory: item.category || 'Unknown Category',
                                    productSize: item.size || item.dimension || 'Unknown Size',
                                    productImage: item.images && item.images.length > 0 ? item.images[0] : null
                                };
                                productFound = true;
                                this.updateStatus(`Found: ${productInfo.productName}`, 'success');
                            }
                        } catch (upcError) {
                            console.log('UPCitemdb lookup failed:', upcError);
                        }
                    }
                    
                    // If still not found, try Barcode Lookup API
                    if (!productFound) {
                        try {
                            const barcodeResponse = await fetch(`https://api.barcodelookup.com/v3/products?barcode=${barcode}&formatted=y&key=YOUR_API_KEY`);
                            const barcodeData = await barcodeResponse.json();
                            
                            if (barcodeData.products && barcodeData.products.length > 0) {
                                const product = barcodeData.products[0];
                                productInfo = {
                                    ...productInfo,
                                    found: true,
                                    productName: product.product_name || 'Unknown Product',
                                    productBrand: product.brand || 'Unknown Brand',
                                    productCategory: product.category || 'Unknown Category',
                                    productSize: product.size || product.weight || 'Unknown Size',
                                    productImage: product.images && product.images.length > 0 ? product.images[0] : null
                                };
                                productFound = true;
                                this.updateStatus(`Found: ${productInfo.productName}`, 'success');
                            }
                        } catch (barcodeError) {
                            console.log('Barcode Lookup API failed:', barcodeError);
                        }
                    }
                    
                    // If no database found the product
                    if (!productFound) {
                        productInfo.productName = 'Unknown Product';
                        productInfo.productBrand = 'Unknown Brand';
                        productInfo.productCategory = 'Unknown Category';
                        productInfo.productSize = 'Unknown Size';
                        this.updateStatus('Product not found in database', 'info');
                    }
                    
                    // Store product info and show quantity modal
                    this.currentProductInfo = productInfo;
                    this.showQuantityModal();
                    
                } catch (error) {
                    console.error('Error looking up product:', error);
                    
                    // Save basic barcode info even if lookup fails
                    const basicInfo = {
                        code: barcode,
                        timestamp: new Date().toISOString(),
                        found: false,
                        productName: 'Unknown Product',
                        productBrand: 'Unknown Brand',
                        productCategory: 'Unknown Category',
                        productSize: 'Unknown Size',
                        quantity: 1
                    };
                    
                    this.currentProductInfo = basicInfo;
                    this.showQuantityModal();
                    this.updateStatus('Barcode saved (lookup failed)', 'info');
                }
            }

            showQuantityModal() {
                if (!this.currentProductInfo) return;
                
                // Update modal content
                document.getElementById('modalProductName').textContent = this.currentProductInfo.productName || 'Unknown Product';
                document.getElementById('modalProductBrand').textContent = this.currentProductInfo.productBrand || 'Unknown Brand';
                this.quantityInput.value = '1';
                
                // Show modal
                this.quantityModal.style.display = 'block';
                this.quantityInput.focus();
                this.quantityInput.select();
            }

            hideQuantityModal() {
                this.quantityModal.style.display = 'none';
                this.currentProductInfo = null;
            }

            confirmQuantity() {
                if (!this.currentProductInfo) return;
                
                const quantity = parseInt(this.quantityInput.value) || 1;
                this.currentProductInfo.quantity = quantity;
                
                // Save to localStorage
                this.saveScannedItem(this.currentProductInfo);
                
                // Hide modal
                this.hideQuantityModal();
                
                // Update home page data
                if (homePage) {
                    homePage.scannedData = homePage.loadData();
                    homePage.updateStats();
                    homePage.displayRecentScans();
                }
                
                this.updateStatus(`Added ${quantity} x ${this.currentProductInfo.productName}`, 'success');
            }

            cancelQuantity() {
                this.hideQuantityModal();
                this.updateStatus('Scan cancelled', 'info');
            }

            saveScannedItem(item) {
                try {
                    const datasets = JSON.parse(localStorage.getItem('datasets') || '[]');
                    const currentDatasetIndex = datasets.findIndex(ds => ds.active);
                    const currentDataset = datasets[currentDatasetIndex] || { name: 'Current Dataset', data: [] };

                    // Check if this barcode already exists
                    const existingIndex = currentDataset.data.findIndex(existing => existing.code === item.code);
                    
                    if (existingIndex !== -1) {
                        // Update quantity if item already exists
                        currentDataset.data[existingIndex].quantity = (currentDataset.data[existingIndex].quantity || 1) + item.quantity;
                        currentDataset.data[existingIndex].timestamp = item.timestamp;
                    } else {
                        // Add new item to the beginning of the array
                        currentDataset.data.unshift(item);
                    }
                    
                    localStorage.setItem('datasets', JSON.stringify(datasets));
                    console.log('Item saved to localStorage:', item);
                    
                } catch (error) {
                    console.error('Error saving scanned item:', error);
                }
            }
        }

        // Add CSS for status messages
        const additionalCSS = `
            .status {
                margin-top: 15px;
                padding: 10px 15px;
                border-radius: 5px;
                font-weight: 600;
                text-align: center;
            }
            
            .status.hidden {
                display: none;
            }
            
            .status.info {
                background-color: #d1ecf1;
                color: #0c5460;
                border: 1px solid #bee5eb;
            }
            
            .status.success {
                background-color: #d4edda;
                color: #155724;
                border: 1px solid #c3e6cb;
            }
            
            .status.error {
                background-color: #f8d7da;
                color: #721c24;
                border: 1px solid #f5c6cb;
            }
            
            #scanner video {
                width: 100%;
                height: auto;
                border-radius: 10px;
            }
            
            #scanner canvas {
                display: none;
            }
        `;
        
        // Add the CSS to the page
        const style = document.createElement('style');
        style.textContent = additionalCSS;
        document.head.appendChild(style);

        class HomePage {
            constructor() {
                this.scannedData = this.loadData();
                this.updateStats();
                this.displayRecentScans();
                this.updateCurrentDatasetDisplay();
            }

            loadData() {
                try {
                    const datasets = JSON.parse(localStorage.getItem('datasets') || '[]');
                    const currentDatasetIndex = datasets.findIndex(ds => ds.active);
                    const currentDataset = datasets[currentDatasetIndex];
                    
                    if (currentDataset) {
                        return currentDataset.data || [];
                    }
                    
                    // Fallback to legacy scannedBarcodes if no dataset is active
                    const legacyData = localStorage.getItem('scannedBarcodes');
                    return legacyData ? JSON.parse(legacyData) : [];
                } catch (error) {
                    console.error('Error loading data:', error);
                    return [];
                }
            }

            updateCurrentDatasetDisplay() {
                try {
                    const datasets = JSON.parse(localStorage.getItem('datasets') || '[]');
                    const currentDatasetIndex = datasets.findIndex(ds => ds.active);
                    const currentDataset = datasets[currentDatasetIndex];
                    
                    const displayElement = document.getElementById('currentDatasetDisplay');
                    if (displayElement) {
                        displayElement.textContent = currentDataset ? currentDataset.name : 'No Dataset Selected';
                    }
                } catch (error) {
                    console.error('Error updating dataset display:', error);
                }
            }

            updateStats() {
                const totalItems = this.scannedData.length;
                const totalQuantity = this.scannedData.reduce((sum, item) => sum + (item.quantity || 1), 0);
                const foundProducts = this.scannedData.filter(item => item.found).length;
                const unknownProducts = this.scannedData.filter(item => !item.found).length;

                document.getElementById('totalItems').textContent = totalItems;
                document.getElementById('totalQuantity').textContent = totalQuantity;
                document.getElementById('foundProducts').textContent = foundProducts;
                document.getElementById('unknownProducts').textContent = unknownProducts;
            }

            displayRecentScans() {
                const recentScansList = document.getElementById('recentScansList');
                
                if (this.scannedData.length === 0) {
                    recentScansList.innerHTML = `
                        <div class="empty-state">
                            <div class="icon">📦</div>
                            <p>No scanned items yet. Start scanning to see your products here!</p>
                        </div>
                    `;
                    return;
                }

                const recentScans = this.scannedData.slice(0, 5);
                recentScansList.innerHTML = recentScans.map(item => `
                    <div class="scan-item">
                        <div class="scan-info">
                            <div class="scan-name">${item.productName || 'Unknown Product'}</div>
                            <div class="scan-details">
                                ${item.productBrand || 'Unknown Brand'} • 
                                ${item.code} • 
                                ${new Date(item.timestamp).toLocaleDateString()}
                            </div>
                        </div>
                        <div class="scan-quantity">Qty: ${item.quantity || 1}</div>
                    </div>
                `).join('');
            }

            async exportToPDF() {
                if (this.scannedData.length === 0) {
                    alert('No scanned items to export. Please scan some products first.');
                    return;
                }

                const loadingDiv = document.getElementById('loadingPDF');
                loadingDiv.style.display = 'block';

                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();

                    // Add title
                    doc.setFontSize(20);
                    doc.setTextColor(102, 126, 234);
                    doc.text('Barcode Scanner Report', 20, 20);

                    // Add generation date
                    doc.setFontSize(12);
                    doc.setTextColor(100, 100, 100);
                    doc.text(`Generated on: ${new Date().toLocaleDateString()} at ${new Date().toLocaleTimeString()}`, 20, 30);

                    // Add summary statistics
                    doc.setFontSize(14);
                    doc.setTextColor(0, 0, 0);
                    doc.text('Summary Statistics', 20, 45);

                    const totalItems = this.scannedData.length;
                    const totalQuantity = this.scannedData.reduce((sum, item) => sum + (item.quantity || 1), 0);
                    const foundProducts = this.scannedData.filter(item => item.found).length;
                    const unknownProducts = this.scannedData.filter(item => !item.found).length;

                    doc.setFontSize(10);
                    doc.text(`Total Items: ${totalItems}`, 20, 55);
                    doc.text(`Total Quantity: ${totalQuantity}`, 20, 62);
                    doc.text(`Found Products: ${foundProducts}`, 20, 69);
                    doc.text(`Unknown Products: ${unknownProducts}`, 20, 76);

                    // Prepare table data
                    const tableData = this.scannedData.map((item, index) => [
                        index + 1,
                        item.productName || 'Unknown Product',
                        item.productBrand || 'Unknown Brand',
                        item.code || 'N/A',
                        item.productCategory || 'Unknown Category',
                        item.quantity || 1,
                        item.found ? 'Yes' : 'No',
                        new Date(item.timestamp).toLocaleDateString()
                    ]);

                    // Add table
                    doc.autoTable({
                        startY: 85,
                        head: [['#', 'Product Name', 'Brand', 'Barcode', 'Category', 'Qty', 'Found', 'Date']],
                        body: tableData,
                        theme: 'striped',
                        headStyles: {
                            fillColor: [102, 126, 234],
                            textColor: 255,
                            fontSize: 10,
                            fontStyle: 'bold'
                        },
                        bodyStyles: {
                            fontSize: 9,
                            cellPadding: 3
                        },
                        alternateRowStyles: {
                            fillColor: [248, 249, 250]
                        },
                        columnStyles: {
                            0: { cellWidth: 15 }, // #
                            1: { cellWidth: 40 }, // Product Name
                            2: { cellWidth: 30 }, // Brand
                            3: { cellWidth: 35 }, // Barcode
                            4: { cellWidth: 25 }, // Category
                            5: { cellWidth: 15 }, // Qty
                            6: { cellWidth: 15 }, // Found
                            7: { cellWidth: 25 }  // Date
                        },
                        margin: { left: 10, right: 10 },
                        didDrawPage: function (data) {
                            // Add page numbers
                            const pageCount = doc.internal.getNumberOfPages();
                            const pageSize = doc.internal.pageSize;
                            const pageHeight = pageSize.height ? pageSize.height : pageSize.getHeight();
                            
                            doc.setFontSize(8);
                            doc.setTextColor(100, 100, 100);
                            doc.text(
                                `Page ${data.pageNumber} of ${pageCount}`,
                                pageSize.width - 30,
                                pageHeight - 10
                            );
                        }
                    });

                    // Generate filename with timestamp
                    const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                    const filename = `barcode-report-${timestamp}.pdf`;

                    // Save the PDF
                    doc.save(filename);

                    loadingDiv.style.display = 'none';
                    
                    // Show success message
                    setTimeout(() => {
                        alert(`PDF report generated successfully!\nFilename: ${filename}`);
                    }, 500);

                } catch (error) {
                    console.error('Error generating PDF:', error);
                    loadingDiv.style.display = 'none';
                    alert('Error generating PDF report. Please try again.');
                }
            }
        }

        function viewScannedItems() {
            openItemsModal();
        }

        function exportToPDF() {
            homePage.exportToPDF();
        }

        function openDatasetManager() {
            openDatasetModal();
        }

        function openItemsModal() {
            const modal = document.getElementById('itemsModal');
            modal.style.display = 'block';
            loadItemsInModal();
        }

        function closeItemsModal() {
            document.getElementById('itemsModal').style.display = 'none';
        }

        function loadItemsInModal() {
            const itemsList = document.getElementById('itemsList');
            const datasets = JSON.parse(localStorage.getItem('datasets') || '[]');
            const currentDatasetIndex = datasets.findIndex(ds => ds.active);
            const currentDataset = datasets[currentDatasetIndex] || { name: 'Current Dataset', data: [] };

            document.getElementById('itemsModalDatasetName').textContent = currentDataset.name;

            if (currentDataset.data.length === 0) {
                itemsList.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">📦</div>
                        <p>No scanned items yet in this dataset. Start scanning to see your products here!</p>
                    </div>
                `;
                return;
            }

            itemsList.innerHTML = `
                <div class="item-row" style="font-weight: bold; background-color: #f8f9fa;">
                    <div>Product Details</div>
                    <div>Barcode</div>
                    <div>Quantity</div>
                    <div>Date</div>
                    <div>Action</div>
                </div>
            ` + currentDataset.data.map((item, index) => `
                <div class="item-row">
                    <div class="item-details">
                        <h4>${item.productName || 'Unknown Product'}</h4>
                        <p>${item.productBrand || 'Unknown Brand'} • ${item.productCategory || 'Unknown Category'}</p>
                    </div>
                    <div>${item.code}</div>
                    <div>${item.quantity || 1}</div>
                    <div>${new Date(item.timestamp).toLocaleDateString()}</div>
                    <div>
                        <button class="delete-btn" onclick="deleteItem(${index})">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function deleteItem(index) {
            const datasets = JSON.parse(localStorage.getItem('datasets') || '[]');
            const currentDatasetIndex = datasets.findIndex(ds => ds.active);
            const currentDataset = datasets[currentDatasetIndex] || { name: 'Current Dataset', data: [] };
            const item = currentDataset.data[index];
            
            if (confirm(`Are you sure you want to delete "${item.productName || 'Unknown Product'}"?`)) {
                currentDataset.data.splice(index, 1);
                localStorage.setItem('datasets', JSON.stringify(datasets));
                
                // Refresh the modal content
                loadItemsInModal();
                
                // Update home page stats
                if (homePage) {
                    homePage.scannedData = homePage.loadData();
                    homePage.updateStats();
                    homePage.displayRecentScans();
                }
                
                alert('Item deleted successfully!');
            }
        }

        function deleteAllItems() {
            const datasets = JSON.parse(localStorage.getItem('datasets') || '[]');
            const currentDatasetIndex = datasets.findIndex(ds => ds.active);
            const currentDataset = datasets[currentDatasetIndex] || { name: 'Current Dataset', data: [] };

            if (confirm(`Are you sure you want to delete ALL items in "${currentDataset.name}"? This action cannot be undone.`)) {
                currentDataset.data = [];
                localStorage.setItem('datasets', JSON.stringify(datasets));
                alert(`All items in "${currentDataset.name}" deleted.`);
                loadItemsInModal();
                if (homePage) {
                    homePage.scannedData = homePage.loadData();
                    homePage.updateStats();
                    homePage.displayRecentScans();
                }
            }
        }

        function openDatasetModal() {
            const modal = document.getElementById('datasetModal');
            modal.style.display = 'block';
            loadDatasets();
        }

        function closeDatasetModal() {
            document.getElementById('datasetModal').style.display = 'none';
        }

        function createNewDataset() {
            const newDatasetName = document.getElementById('newDatasetName').value.trim();
            if (!newDatasetName) {
                alert('Dataset name cannot be empty.');
                return;
            }

            const datasets = JSON.parse(localStorage.getItem('datasets') || '[]');
            if (datasets.some(ds => ds.name === newDatasetName)) {
                alert('A dataset with this name already exists.');
                return;
            }

            datasets.push({ name: newDatasetName, data: [], active: false }); // Initialize with empty data and inactive
            localStorage.setItem('datasets', JSON.stringify(datasets));
            alert(`Dataset "${newDatasetName}" created successfully!`);
            loadDatasets();
            closeDatasetModal();
        }

        function loadDatasets() {
            const datasetList = document.getElementById('datasetList');
            const currentDatasetName = document.getElementById('currentDatasetName');
            let datasets = JSON.parse(localStorage.getItem('datasets') || '[]');

            // Initialize with a default dataset if none exist
            if (datasets.length === 0) {
                datasets = [{ name: 'Default Dataset', data: [], active: true }];
                localStorage.setItem('datasets', JSON.stringify(datasets));
            }

            // Ensure at least one dataset is active
            const activeDatasetIndex = datasets.findIndex(ds => ds.active);
            if (activeDatasetIndex === -1) {
                datasets[0].active = true;
                localStorage.setItem('datasets', JSON.stringify(datasets));
            }

            const activeDataset = datasets.find(ds => ds.active);
            
            datasetList.innerHTML = '';
            currentDatasetName.textContent = activeDataset ? activeDataset.name : 'No dataset selected';

            // Update the main page display
            const displayElement = document.getElementById('currentDatasetDisplay');
            if (displayElement) {
                displayElement.textContent = activeDataset ? activeDataset.name : 'No Dataset Selected';
            }

            datasets.forEach((dataset, index) => {
                const datasetItem = document.createElement('div');
                datasetItem.className = dataset.active ? 'dataset-item active' : 'dataset-item';
                datasetItem.innerHTML = `
                    <div class="dataset-info">
                        <h4>${dataset.name}</h4>
                        <p>Items: ${dataset.data.length}</p>
                    </div>
                    <div class="dataset-actions">
                        ${dataset.active ? 
                            '<button class="btn btn-success">Active</button>' : 
                            `<button class="btn btn-primary" onclick="activateDataset(${index})">Activate</button>`
                        }
                        <button class="btn btn-secondary" onclick="deleteDataset(${index})">Delete</button>
                    </div>
                `;
                datasetList.appendChild(datasetItem);
            });
        }

        function activateDataset(index) {
            let datasets = JSON.parse(localStorage.getItem('datasets') || '[]');
            datasets.forEach(ds => ds.active = false);
            datasets[index].active = true;
            localStorage.setItem('datasets', JSON.stringify(datasets));
            
            // Update displays
            const displayElement = document.getElementById('currentDatasetDisplay');
            if (displayElement) {
                displayElement.textContent = datasets[index].name;
            }
            
            document.getElementById('currentDatasetName').textContent = datasets[index].name;
            alert(`Dataset "${datasets[index].name}" activated.`);
            loadDatasets(); // Reload to update active class
            
            // Refresh home page data
            if (homePage) {
                homePage.scannedData = homePage.loadData();
                homePage.updateStats();
                homePage.displayRecentScans();
                homePage.updateCurrentDatasetDisplay();
            }
        }

        function deleteDataset(index) {
            const datasets = JSON.parse(localStorage.getItem('datasets') || '[]');
            const datasetName = datasets[index].name;
            if (confirm(`Are you sure you want to delete dataset "${datasetName}"? This action cannot be undone.`)) {
                datasets.splice(index, 1);
                localStorage.setItem('datasets', JSON.stringify(datasets));
                alert(`Dataset "${datasetName}" deleted.`);
                loadDatasets();
                if (datasets.length === 0) {
                    document.getElementById('currentDatasetName').textContent = 'No dataset selected';
                } else if (datasets.length === 1) {
                    activateDataset(0);
                }
            }
        }

        function scrollToScanner() {
            const scannerSection = document.querySelector('.scanner-section');
            if (scannerSection) {
                scannerSection.scrollIntoView({ behavior: 'smooth' });
            }
        }

        function adjustQuantity(change) {
            const input = document.getElementById('quantityInput');
            const currentValue = parseInt(input.value) || 1;
            const newValue = Math.max(1, currentValue + change);
            input.value = newValue;
        }

        function confirmQuantity() {
            if (barcodeScanner) {
                barcodeScanner.confirmQuantity();
            }
        }

        function cancelQuantity() {
            if (barcodeScanner) {
                barcodeScanner.cancelQuantity();
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const quantityModal = document.getElementById('quantityModal');
            const itemsModal = document.getElementById('itemsModal');
            const datasetModal = document.getElementById('datasetModal');
            if (event.target === quantityModal) {
                cancelQuantity();
            }
            if (event.target === itemsModal) {
                closeItemsModal();
            }
            if (event.target === datasetModal) {
                closeDatasetModal();
            }
        }

        // Handle Enter key in quantity input
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('quantityInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    confirmQuantity();
                }
            });
        });

        // Initialize the barcode scanner and home page when the document loads
        let homePage;
        let barcodeScanner;
        document.addEventListener('DOMContentLoaded', () => {
            homePage = new HomePage();
            barcodeScanner = new BarcodeScanner();
            loadDatasets(); // Load datasets on page load
        });

        // Refresh data when page becomes visible (in case user scanned items in another tab)
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden && homePage) {
                homePage.scannedData = homePage.loadData();
                homePage.updateStats();
                homePage.displayRecentScans();
            }
        });
    </script>
</body>
</html>
